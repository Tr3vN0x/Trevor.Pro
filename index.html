<?php
$title = "LunarTrev";
?>
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title><?php echo $title; ?></title>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">

<style>
body {
  margin:0;
  font-family:'Poppins',sans-serif;
  background:#05070a;
  color:#e8ebff;
}
main { max-width:500px; margin:auto; padding:1rem 1.5rem 6rem; }
.card {
  background:rgba(13,19,45,.75);
  border:1px solid rgba(207,216,255,.15);
  border-radius:24px;
  padding:1.2rem;
  margin-bottom:1rem;
}
textarea,input {
  width:100%;
  padding:1rem;
  border-radius:12px;
  border:none;
  margin-bottom:1rem;
}
button {
  width:100%;
  padding:1rem;
  border-radius:12px;
  font-weight:700;
  cursor:pointer;
}
.avatar { width:42px; height:42px; border-radius:50%; }
.nav {
  position:fixed; bottom:20px; left:50%; transform:translateX(-50%);
  display:flex; gap:20px;
}
.nav span { cursor:pointer; opacity:.6; }
.nav span.active { opacity:1; font-weight:700; }
.hidden { display:none; }
.pulse-btn {
  margin-top:10px;
  padding:6px 14px;
  border-radius:18px;
  border:1px solid #777;
  background:none;
  color:#fff;
}
</style>
</head>

<body>
<main>

<!-- AUTH -->
<div id="auth-view">
  <div class="card">
    <h2>LUNARTREV</h2>
    <form id="auth-form">
      <input id="reg-username" placeholder="Pilot Username" required>
      <input id="email" type="email" placeholder="Earth Email" required>
      <input id="password" type="password" placeholder="Security Key" required>
      <button>Access System</button>
    </form>
  </div>
</div>

<!-- FEED -->
<div id="home-tab" class="hidden">
  <div class="card">
    <textarea id="post-content" rows="3" placeholder="Broadcast to the sector..."></textarea>
    <button id="send-btn" disabled>Transmit</button>
  </div>
  <div id="feed"></div>
</div>

<!-- PROFILE -->
<div id="profile-tab" class="hidden">
  <div class="card" style="text-align:center">
    <img id="my-avatar" class="avatar" style="width:90px;height:90px"><br><br>
    <strong id="disp-name">Pilot</strong>
    <p id="disp-bio"></p>
    <button id="logout-btn">Logout</button>
  </div>
</div>

</main>

<div class="nav hidden" id="nav">
  <span data-tab="home-tab" class="active">Feed</span>
  <span data-tab="profile-tab">Profile</span>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut,
  createUserWithEmailAndPassword, signInWithEmailAndPassword }
from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import {
  getFirestore, doc, setDoc, getDoc, updateDoc,
  collection, addDoc, deleteDoc,
  query, orderBy, limit, startAfter,
  getDocs, serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCGTSiMcNQaAVjkEI_9YRbb2C4CTvqQWEM",
  authDomain: "lunartrev.firebaseapp.com",
  projectId: "lunartrev",
  storageBucket: "lunartrev.firebasestorage.app",
  messagingSenderId: "152908127950",
  appId: "1:152908127950:web:6db39b55cbe5d5b0f33a9f"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let currentUser = null;
let lastVisible = null;
let loading = false;
const PAGE_SIZE = 5;

const qs = id => document.getElementById(id);

/* NAV */
document.querySelectorAll('.nav span').forEach(n=>{
  n.onclick=()=>{
    document.querySelectorAll('.nav span').forEach(x=>x.classList.remove('active'));
    document.querySelectorAll('#home-tab,#profile-tab').forEach(x=>x.classList.add('hidden'));
    qs(n.dataset.tab).classList.remove('hidden');
    n.classList.add('active');
  }
});

/* AUTH STATE */
onAuthStateChanged(auth, async user=>{
  currentUser=user;
  qs('send-btn').disabled=!user;

  if(!user) return;

  qs('auth-view').classList.add('hidden');
  qs('home-tab').classList.remove('hidden');
  qs('nav').classList.remove('hidden');

  const snap=await getDoc(doc(db,'users',user.uid));
  if(snap.exists()){
    const d=snap.data();
    qs('disp-name').innerText=d.username;
    qs('disp-bio').innerText=d.bio;
    qs('my-avatar').src=d.profile_Image;
  }
});

/* SIGNUP / LOGIN */
qs('auth-form').onsubmit=async e=>{
  e.preventDefault();
  try{
    const cred=await createUserWithEmailAndPassword(auth,email.value,password.value);
    await setDoc(doc(db,'users',cred.user.uid),{
      username:reg_username.value,
      bio:"Exploration log started.",
      profile_Image:`https://api.dicebear.com/7.x/bottts/svg?seed=${reg_username.value}`,
      joinedAt:serverTimestamp()
    });
  }catch(err){
    if(err.code==='auth/email-already-in-use'){
      await signInWithEmailAndPassword(auth,email.value,password.value);
    }
  }
};

/* POSTING â€” FIXED */
qs('send-btn').onclick=async()=>{
  if(!currentUser) return;
  const text=qs('post-content').value.trim();
  if(!text) return;

  const uSnap=await getDoc(doc(db,'users',currentUser.uid));
  const u=uSnap.data();

  await addDoc(collection(db,'posts'),{
    text,
    authorId:currentUser.uid,
    authorName:u.username,
    authorImg:u.profile_Image,
    timestamp:serverTimestamp()
  });

  qs('post-content').value="";
};

/* RENDER POST */
function renderPost(d){
  const p=d.data();
  const isOwner=p.authorId===currentUser?.uid;

  const c=document.createElement('div');
  c.className='card';
  c.innerHTML=`
    <div style="display:flex;gap:10px;align-items:center">
      <img class="avatar" src="${p.authorImg}">
      <strong>${p.authorName}</strong>
    </div>
    <div class="post-text">${p.text}</div>
    ${isOwner?'<button class="pulse-btn edit">Edit</button><button class="pulse-btn delete">Delete</button>':''}
  `;

  if(isOwner){
    c.querySelector('.delete').onclick=async()=>{
      if(confirm('Delete post?')) await deleteDoc(doc(db,'posts',d.id));
    };
    c.querySelector('.edit').onclick=async()=>{
      const nt=prompt('Edit post:',p.text);
      if(nt && nt!==p.text) await updateDoc(doc(db,'posts',d.id),{text:nt});
    };
  }

  qs('feed').appendChild(c);
}

/* PAGINATION */
async function loadPosts(){
  if(loading) return;
  loading=true;

  let q=query(collection(db,'posts'),orderBy('timestamp','desc'),limit(PAGE_SIZE));
  if(lastVisible){
    q=query(collection(db,'posts'),orderBy('timestamp','desc'),startAfter(lastVisible),limit(PAGE_SIZE));
  }

  const snap=await getDocs(q);
  if(!snap.empty){
    lastVisible=snap.docs[snap.docs.length-1];
    snap.forEach(renderPost);
  }
  loading=false;
}

loadPosts();
window.addEventListener('scroll',()=>{
  if(innerHeight+scrollY>=document.body.offsetHeight-200) loadPosts();
});

/* LOGOUT */
qs('logout-btn').onclick=()=>signOut(auth);
</script>
</body>
</html>
